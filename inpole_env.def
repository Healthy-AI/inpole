Bootstrap: docker

From: continuumio/miniconda3:latest

%files
    cos_installer_preview-22.1.1.0.R0-M08SWML-linux-x86-64.bin
    cos_installer.properties

%post
    # Install CPLEX Optimization Studio.
    ./cos_installer_preview-22.1.1.0.R0-M08SWML-linux-x86-64.bin \
        -f ./cos_installer.properties

    # Install gcc, graphviz, libgmp3-dev, and rsync.
    apt-get update && apt-get install -y gcc
    apt-get install -y graphviz
    apt-get install -y libgmp3-dev
    apt-get install -y rsync

    # Clone the risk-slim and aix360 repositories.
    git clone https://github.com/antmats/risk-slim.git
    git clone https://github.com/Trusted-AI/AIX360

    # Install conda packages.
    rsync -r /mnt/inpole . --exclude='*_env'
    cd inpole
    . /opt/conda/etc/profile.d/conda.sh
    conda env create -f environment.yml

    # Install other packages using Poetry.
    env_name=$(head -1 environment.yml | cut -d' ' -f2)
    conda activate $env_name
    poetry install --without dev

    # Install PyFIM.
    cd ..
    wget https://borgelt.net/src/pyfim.tar.gz
    mkdir pyfim && tar -xzf pyfim.tar.gz -C pyfim
    cd pyfim
    $CONDA_PREFIX/bin/python setup_fim.py install

    # Activate the environment when the container is run.
    echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
    echo "conda activate $env_name" >> $SINGULARITY_ENVIRONMENT

%environment
    # Use the latest version of the inpole package.
    export PYTHONPATH=/mnt/inpole:$PYTHONPATH
