Bootstrap: docker

From: continuumio/miniconda3:latest

%files
    environment.yml

%post
    # Clone the risk-slim repository.
    git clone https://github.com/ustunb/risk-slim.git

    # Clone the inpole repository.
    git clone https://github.com/antmats/inpole.git

    # Install gcc.
    apt-get update && apt-get install -y gcc

    # Install conda packages.
    #
    # The risk-slim repository is assumed to be located at ../risk-slim so we
    # change the working directory.
    cd inpole
    . /opt/conda/etc/profile.d/conda.sh
    conda env create -f environment.yml

    # Install other packages using Poetry.
    ENV_NAME=$(head -1 environment.yml | cut -d' ' -f2)
    conda activate $ENV_NAME
    poetry install

    # Make sure that the environment is activated when the container is run.
    echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
    echo "conda activate $ENV_NAME" >> $SINGULARITY_ENVIRONMENT
    